- hosts: all
  become: yes
  vars:
    user: devops

  tasks:
    - name: "Create the {{ user }} user"
      user: name="{{ user }}" append=yes state=present createhome=yes shell=/bin/bash

    - name: "Allow {{ user }} to have passwordless sudo"
      lineinfile:
        dest: /etc/sudoers
        line: "{{ user }} ALL=(ALL) NOPASSWD: ALL"
        validate: 'visudo -cf %s'

    - name: "Set up authorized keys for the {{ user }} user"
      authorized_key: user="{{ user }}" key="{{ item }}"
      with_file:
        - ~/.ssh/id_rsa.pub